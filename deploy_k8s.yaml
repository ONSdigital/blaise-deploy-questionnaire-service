steps:
  - name: "gcr.io/kaniko-project/executor:latest"
    args:
      - --destination=eu.gcr.io/$PROJECT_ID/blaise-survey-manager:${SHORT_SHA}
      - --destination=eu.gcr.io/$PROJECT_ID/blaise-survey-manager:latest
      - --cache=true
      - --cache-ttl=168h

  - name: "gcr.io/cloud-builders/gcloud"
    id: Update SHA in Bucket
    entrypoint: /bin/sh
    args:
      - "-c"
      - |
        echo Writing ${SHORT_SHA} to file.
        echo -n ${SHORT_SHA} >> bsm.txt
        echo Copying file to ${_ENV} bucket.
        gsutil cp bsm.txt gs://ons-blaise-${_ENV}-image-tags/tags/bsm.txt
    
  - name: "gcr.io/cloud-builders/gcloud"
    id: Trigger Terraform Apply
    entrypoint: /bin/sh
    args:
      - "-c"
      - |
        echo Triggering Terraform Apply Cloud Build Job
        gcloud beta builds triggers run terraform-apply --branch ${_GIT_BRANCH}
